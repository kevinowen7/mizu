<!doctype html>
<html lang="en">

<head>
    <%- include('../partials-admin/head.ejs') %>
    <title>Analytics Dashboard - Mizu</title>
</head>
<body>
    <div class="app-container app-theme-white body-tabs-shadow fixed-sidebar fixed-header">
        <%- include('../partials-admin/menu.ejs') %>
            <div class="app-main">
                <div class="app-sidebar sidebar-shadow">
                    <div class="app-header__logo">
                        <div class="logo-src"></div>
                        <div class="header__pane ml-auto">
                            <div>
                                <button type="button" class="hamburger close-sidebar-btn hamburger--elastic" data-class="closed-sidebar">
                                    <span class="hamburger-box">
                                        <span class="hamburger-inner"></span>
                                    </span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="app-header__mobile-menu">
                        <div>
                            <button type="button" class="hamburger hamburger--elastic mobile-toggle-nav">
                                <span class="hamburger-box">
                                    <span class="hamburger-inner"></span>
                                </span>
                            </button>
                        </div>
                    </div>
                    <div class="app-header__menu">
                        <span>
                            <button type="button" class="btn-icon btn-icon-only btn btn-primary btn-sm mobile-toggle-header-nav">
                                <span class="btn-icon-wrapper">
                                    <i class="fa fa-ellipsis-v fa-w-6"></i>
                                </span>
                            </button>
                        </span>
                    </div>    <div class="scrollbar-sidebar">
                        <div class="app-sidebar__inner">
                            <ul class="vertical-nav-menu">
                                <li class="app-sidebar__heading">Dashboard</li>
                                <li>
                                    <a href="./dashboard" class="mm-active">
                                        <i class="metismenu-icon pe-7s-rocket"></i>
                                        Dashboard
                                    </a>
                                </li>
                            </ul>
                            <ul class="vertical-nav-menu">
                                <li class="app-sidebar__heading">Stock</li>
                                <li>
                                    <a href="./stock" >
                                        <i class="metismenu-icon pe-7s-box2"></i>
                                        Stock
                                    </a>
                                </li>
                            </ul>
                            <ul class="vertical-nav-menu">
                                <li class="app-sidebar__heading">History</li>
                                <li>
                                    <a href="./history">
                                        <i class="metismenu-icon pe-7s-timer"></i>
                                        History
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>    
                <div class="app-main__outer">    
                    <div class="app-main__inner">
                        <div class="row">
                            <div class="col-md-6 col-xl-4">
                                <div class="card mb-3 widget-content bg-midnight-bloom">
                                    <div class="widget-content-wrapper text-white">
                                        <div class="widget-content-left">
                                            <div class="widget-heading">Total Orders</div>
                                            <div class="widget-subheading">Today</div>
                                        </div>
                                        <div class="widget-content-right">
                                            <div class="widget-numbers text-white"><span id="total_order"></span></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 col-xl-4">
                                <div class="card mb-3 widget-content bg-arielle-smile">
                                    <div class="widget-content-wrapper text-white">
                                        <div class="widget-content-left">
                                            <div class="widget-heading">Total Profits</div>
                                            <div class="widget-subheading">Today</div>
                                        </div>
                                        <div class="widget-content-right">
                                            <div class="widget-numbers text-white"><span id="total_profit"></span></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 col-xl-4">
                                <div class="card mb-3 widget-content bg-grow-early">
                                    <div class="widget-content-wrapper text-white">
                                        <div class="widget-content-left">
                                            <div class="widget-heading">Total Gallons Sold</div>
                                            <div class="widget-subheading">Today</div>
                                        </div>
                                        <div class="widget-content-right">
                                            <div class="widget-numbers text-white"><span id="total_gallon"></span></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12 col-lg-12">
                                <div class="mb-3 card">
                                    <div class="card-header-tab card-header">
                                        <div class="card-header-title">
                                            <i class="header-icon lnr-rocket icon-gradient bg-tempting-azure"> </i>
                                            Orders Reports
                                        </div>
                                    </div>
                                    <div class="tab-content">
                                        <div class="tab-pane fade active show" id="tab-eg-55">
                                            <div class="pt-2 card-body">
                                                <div class="chartjs-size-monitor" style="position: absolute; left: 0px; top: 0px; right: 0px; bottom: 0px; overflow: hidden; pointer-events: none; visibility: hidden; z-index: -1;"><div class="chartjs-size-monitor-expand" style="position:absolute;left:0;top:0;right:0;bottom:0;overflow:hidden;pointer-events:none;visibility:hidden;z-index:-1;"><div style="position:absolute;width:1000000px;height:1000000px;left:0;top:0"></div></div><div class="chartjs-size-monitor-shrink" style="position:absolute;left:0;top:0;right:0;bottom:0;overflow:hidden;pointer-events:none;visibility:hidden;z-index:-1;"><div style="position:absolute;width:200%;height:200%;left:0; top:0"></div></div></div>
                                                <canvas id="bar-chart" height="435" width="870" class="chartjs-render-monitor" style="display: block; height: 145px; width: 290px;"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="main-card mb-3 card">
                                    <div class="card-header">active orders List
                                    </div>
                                    <div class="table-responsive">
                                        <table class="align-middle mb-0 table table-borderless table-striped table-hover" style="text-align: center;">
                                            <thead>
                                            <tr>
                                                <th>#</th>
                                                <th>Customer</th>
                                                <th>Date</th>
                                                <th>Brands</th>
                                                <th>Quantity</th>
                                                <th>Price</th>
                                                <th>Address</th>
                                                <th>Phone Number</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                            </thead>
                                            <tbody>
                                            <% var x = 0; for(var i = 0; i < results.length; i++) { %>
                                                <% if (results[i].status==0) { %>
                                                <tr id="trans_<%= results[i].trans_id %>">
                                                    <th scope="row"><%= x+1 %></th>
                                                    <td><%= results[i].nama %></td>
                                                    <td class="convertDate"><%= results[i].date %></td>
                                                    <td><%= results[i].brand %></td>
                                                    <td><%= results[i].jmlh_galon %></td>
                                                    <td class="convertMoney"><%= results[i].harga_total %></td>
                                                    <td><%= results[i].alamat %></td>
                                                    <td><%= results[i].no_hp %></td>
                                                    <td class="text-center">
                                                        <div class="badge badge-warning">Pending</div>
                                                    </td>
                                                    <td class="text-center">
                                                        <button class="mr-2 btn-icon btn-icon-only btn btn-outline-danger" onclick="cancel('<%= results[i].trans_id %>')">Cancel</button>
                                                        <button class="btn-wide btn btn-success" onclick="finish('<%= results[i].trans_id %>')">Finish</button>
                                                    </td>
                                                </tr>
                                                <% x=x+1 } %>
                                            <% } %>
                                            
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
    <%- include('../partials-admin/footer.ejs') %>

    <script>

        function formatDate(date) {
            var d = new Date(date),
                month = '' + (d.getMonth() + 1),
                day = '' + d.getDate(),
                year = d.getFullYear();

            if (month.length < 2) 
                month = '0' + month;
            if (day.length < 2) 
                day = '0' + day;

            return [year, month, day].join('-');
        }
        $(".convertDate").each(function() {
            $(this).html(formatDate($(this).html()))
        });

        function rem_moneydot(money) {
	
            return parseInt(money.split(".").join(""));
            
        }

        function get_moneydot(money) {
            
            if (isNaN(parseInt(money))) {
                var convertmoney = "";
            } else {
                money = rem_moneydot(money);
                var convertmoney = money.toString().replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "$1.");
            }
            return convertmoney;
            
        }

        $(".convertMoney").each(function() {
            $(this).html(get_moneydot($(this).html()))
        });
        // Return with commas in between
        var numberWithCommas = function(x) {
            return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        };

        function getRandomColor() {
            var letters = 'BCDEF'.split('');
                var color = '#';
                for (var i = 0; i < 6; i++ ) {
                    color += letters[Math.floor(Math.random() * letters.length)];
                }
                return color;
        }

        function finish(id){
            $("#cover-spin").show()
            $.post( "set_finish",{ id: id })
            .done(function( res ) {
                if (parseInt(res.data.changedRows) == 1){
                    $("#cover-spin").hide()
                    $("#trans_"+id).remove()
                } else {
                    $("#cover-spin").hide()
                    alert("Error finish this order")
                }
            });
        }

        function cancel(id){
            $("#cover-spin").show()
            $.post( "set_cancel",{ id: id })
            .done(function( res ) {
                if (parseInt(res.data.changedRows) == 1){
                    $("#cover-spin").hide()
                    $("#trans_"+id).remove()
                } else {
                    $("#cover-spin").hide()
                    alert("Error cancel this order")
                }
            });
        }

        $.get( "get_graph", { year: "2020" } )
        .done(function( res ) {
            dataQuery = res.data
            var dataPack1 = [40, 47, 44, 38, 27, 31, 25];
            var dataPack2 = [10, 12, 7, 5, 4, 6, 8];
            var dataPack3 = [17, 11, 22, 18, 12, 7, 5];

            var dataPack = []
            var dataIsAppend = []
            
            var dates = ["January", "February", "March", "April", "May", "June", "July", "August","September","October","November","December"];

            for (var i = 0;i<dataQuery.length;i++){
                if (!dataIsAppend.includes(dataQuery[i].brand)){
                    dataIsAppend.push(dataQuery[i].brand);
                }
            }

            for (var i = 0;i<dataIsAppend.length;i++){
                dataPackRow = [0,0,0,0,0,0,0,0,0,0,0,0]
                for (var x = 0;x<dataQuery.length;x++){
                    if (dataIsAppend[i]==dataQuery[x].brand){
                        var index = dates.indexOf(dataQuery[x].Month);
                        dataPackRow[index]=dataQuery[x].quantity
                    }
                }
                dataPack.push(dataPackRow)
            }

            var items =  {
                type: 'bar',
                data: {
                    labels: dates,
                    datasets: []
                },
                options: {
                        animation: {
                        duration: 10,
                    },
                    tooltips: {
                                mode: 'label',
                    callbacks: {
                    label: function(tooltipItem, data) { 
                        return data.datasets[tooltipItem.datasetIndex].label + ": " + numberWithCommas(tooltipItem.yLabel);
                    }
                    }
                    },
                    scales: {
                    xAxes: [{ 
                        stacked: true, 
                        gridLines: { display: false },
                        }],
                    yAxes: [{ 
                        stacked: true, 
                        ticks: {
                                callback: function(value) { return numberWithCommas(value); },
                                }, 
                        }],
                    }, // scales
                    legend: {display: true}
                } // options
            }
            for (var i = 0;i<dataIsAppend.length;i++){
                var color = getRandomColor();
                items.data.datasets.push({
                    label: dataIsAppend[i],
                    data: dataPack[i],
                    backgroundColor: color,
                    hoverBackgroundColor: color,
                    hoverBorderWidth: 0
                });
            }
            
            var bar_ctx = document.getElementById('bar-chart');
            var bar_chart = new Chart(bar_ctx, items);
        });

        $.get( "get_order_today")
        .done(function( res ) {
            $("#total_order").html(res.data[0].total);
        });

        $.get( "get_profit_today")
        .done(function( res ) {
            $("#total_profit").html(get_moneydot(String(res.data[0].total)));
        });

        $.get( "get_gallon_today")
        .done(function( res ) {
            $("#total_gallon").html(res.data[0].total);
        });
        
    </script>
</body>
</html>
